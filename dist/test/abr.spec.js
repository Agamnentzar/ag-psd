"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var canvas_1 = require("canvas");
var chai_1 = require("chai");
var fs = require("fs");
var path = require("path");
var abr_1 = require("../abr");
var common_1 = require("./common");
var testFilesPath = path.join(__dirname, '..', '..', 'test');
var readFilesPath = path.join(testFilesPath, 'abr-read');
var resultsFilesPath = path.join(__dirname, '..', '..', 'results');
describe('ABR', function () {
    fs.readdirSync(readFilesPath).forEach(function (f) {
        // fs.readdirSync(readFilesPath).filter(f => /s/.test(f)).forEach(f => {
        it("reads ABR file (".concat(f, ")"), function () {
            var basePath = path.join(readFilesPath, f);
            var fileName = path.join(basePath, 'src.abr');
            var abr = (0, abr_1.readAbr)(fs.readFileSync(fileName), { logMissingFeatures: true });
            var resultsPath = path.join(resultsFilesPath, 'abr', f);
            fs.mkdirSync(resultsPath, { recursive: true });
            var images = (0, common_1.loadImagesFromDirectory)(basePath);
            var compare = [];
            for (var _i = 0, _a = abr.samples; _i < _a.length; _i++) {
                var sample = _a[_i];
                var canvas = alphaToCanvas(sample.alpha, sample.bounds.w, sample.bounds.h);
                delete sample.alpha;
                var name_1 = "sample-".concat(sample.id, ".png");
                fs.writeFileSync(path.join(resultsPath, name_1), canvas.toBuffer());
                compare.push({ name: name_1, canvas: canvas });
            }
            for (var _b = 0, _c = abr.patterns; _b < _c.length; _b++) {
                var pattern = _c[_b];
                var canvas = rgbToCanvas(pattern.data, pattern.bounds.w, pattern.bounds.h);
                delete pattern.data;
                var name_2 = "pattern-".concat(pattern.id, ".png");
                fs.writeFileSync(path.join(resultsPath, name_2), canvas.toBuffer());
                compare.push({ name: name_2, canvas: canvas });
            }
            // console.log(require('util').inspect(abr, false, 99, true));
            fs.writeFileSync(path.join(resultsPath, 'data.json'), JSON.stringify(abr, null, 2), 'utf8');
            var expected = JSON.parse(fs.readFileSync(path.join(basePath, 'data.json'), 'utf8'));
            (0, chai_1.expect)(abr).eql(expected, f);
            compare.forEach(function (i) { return (0, common_1.compareCanvases)(images[i.name], i.canvas, "".concat(f, "/").concat(i.name)); });
        });
    });
    it.skip('test', function () {
        var fileName = "E:\\Downloads\\Fire_Brushes_-_Pixivu.abr";
        var abr = (0, abr_1.readAbr)(fs.readFileSync(fileName), { logMissingFeatures: true });
        console.log(require('util').inspect(abr, false, 99, true));
    });
    it.skip('test', function () {
        this.timeout(60 * 1000);
        var basePath = "E:\\Downloads\\Brushes-20211231T151021Z-001\\Brushes";
        var outputPath = "E:\\Downloads\\output";
        for (var _i = 0, _a = fs.readdirSync(basePath); _i < _a.length; _i++) {
            var dir = _a[_i];
            var dirPath = path.join(basePath, dir);
            for (var _b = 0, _c = fs.readdirSync(dirPath); _b < _c.length; _b++) {
                var file = _c[_b];
                if (!/\.abr$/.test(file))
                    continue;
                var filePath = path.join(basePath, dir, file);
                console.log(filePath);
                var abr = (0, abr_1.readAbr)(fs.readFileSync(filePath));
                console.log(require('util').inspect(abr, false, 99, true));
                if (0) {
                    fs.rmSync(path.join(outputPath, file), { recursive: true, force: true });
                    fs.mkdirSync(path.join(outputPath, file));
                    for (var _d = 0, _e = abr.samples; _d < _e.length; _d++) {
                        var sample = _e[_d];
                        var canvas = alphaToCanvas(sample.alpha, sample.bounds.w, sample.bounds.h);
                        fs.writeFileSync(path.join(outputPath, file, 'sample-' + sample.id + '.png'), canvas.toBuffer());
                        delete sample.alpha;
                    }
                    for (var _f = 0, _g = abr.patterns; _f < _g.length; _f++) {
                        var pattern = _g[_f];
                        var canvas = rgbToCanvas(pattern.data, pattern.bounds.w, pattern.bounds.h);
                        fs.writeFileSync(path.join(outputPath, file, 'pattern-' + pattern.id + '.png'), canvas.toBuffer());
                        delete pattern.data;
                    }
                    fs.writeFileSync(path.join(outputPath, file, 'info.json'), JSON.stringify(abr, null, 2), 'utf8');
                }
            }
        }
    });
});
function alphaToCanvas(alpha, width, height) {
    var canvas = (0, canvas_1.createCanvas)(width, height);
    var context = canvas.getContext('2d');
    var imageData = context.getImageData(0, 0, canvas.width, canvas.height);
    for (var src = 0, dst = 0; src < alpha.length; src++, dst += 4) {
        imageData.data[dst + 0] = 255;
        imageData.data[dst + 1] = 255;
        imageData.data[dst + 2] = 255;
        imageData.data[dst + 3] = alpha[src];
    }
    context.putImageData(imageData, 0, 0);
    return canvas;
}
function rgbToCanvas(rgb, width, height) {
    var canvas = (0, canvas_1.createCanvas)(width, height);
    var context = canvas.getContext('2d');
    var imageData = context.getImageData(0, 0, canvas.width, canvas.height);
    imageData.data.set(rgb);
    context.putImageData(imageData, 0, 0);
    return canvas;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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OUIsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQ3JDO0lBRUQsT0FBTyxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3RDLE9BQU8sTUFBTSxDQUFDO0FBQ2YsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLEdBQWUsRUFBRSxLQUFhLEVBQUUsTUFBYztJQUNsRSxJQUFNLE1BQU0sR0FBRyxJQUFBLHFCQUFZLEVBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzNDLElBQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFFLENBQUM7SUFDekMsSUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3hCLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN0QyxPQUFPLE1BQU0sQ0FBQztBQUNmLENBQUMiLCJmaWxlIjoidGVzdC9hYnIuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZUNhbnZhcyB9IGZyb20gJ2NhbnZhcyc7XHJcbmltcG9ydCB7IGV4cGVjdCB9IGZyb20gJ2NoYWknO1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IHJlYWRBYnIgfSBmcm9tICcuLi9hYnInO1xyXG5pbXBvcnQgeyBjb21wYXJlQ2FudmFzZXMsIGxvYWRJbWFnZXNGcm9tRGlyZWN0b3J5IH0gZnJvbSAnLi9jb21tb24nO1xyXG5cclxuY29uc3QgdGVzdEZpbGVzUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICcuLicsICd0ZXN0Jyk7XHJcbmNvbnN0IHJlYWRGaWxlc1BhdGggPSBwYXRoLmpvaW4odGVzdEZpbGVzUGF0aCwgJ2Fici1yZWFkJyk7XHJcbmNvbnN0IHJlc3VsdHNGaWxlc1BhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAncmVzdWx0cycpO1xyXG5cclxuZGVzY3JpYmUoJ0FCUicsICgpID0+IHtcclxuXHRmcy5yZWFkZGlyU3luYyhyZWFkRmlsZXNQYXRoKS5mb3JFYWNoKGYgPT4ge1xyXG5cdFx0Ly8gZnMucmVhZGRpclN5bmMocmVhZEZpbGVzUGF0aCkuZmlsdGVyKGYgPT4gL3MvLnRlc3QoZikpLmZvckVhY2goZiA9PiB7XHJcblx0XHRpdChgcmVhZHMgQUJSIGZpbGUgKCR7Zn0pYCwgKCkgPT4ge1xyXG5cdFx0XHRjb25zdCBiYXNlUGF0aCA9IHBhdGguam9pbihyZWFkRmlsZXNQYXRoLCBmKTtcclxuXHRcdFx0Y29uc3QgZmlsZU5hbWUgPSBwYXRoLmpvaW4oYmFzZVBhdGgsICdzcmMuYWJyJyk7XHJcblx0XHRcdGNvbnN0IGFiciA9IHJlYWRBYnIoZnMucmVhZEZpbGVTeW5jKGZpbGVOYW1lKSwgeyBsb2dNaXNzaW5nRmVhdHVyZXM6IHRydWUgfSk7XHJcblxyXG5cdFx0XHRjb25zdCByZXN1bHRzUGF0aCA9IHBhdGguam9pbihyZXN1bHRzRmlsZXNQYXRoLCAnYWJyJywgZik7XHJcblx0XHRcdGZzLm1rZGlyU3luYyhyZXN1bHRzUGF0aCwgeyByZWN1cnNpdmU6IHRydWUgfSk7XHJcblxyXG5cdFx0XHRjb25zdCBpbWFnZXMgPSBsb2FkSW1hZ2VzRnJvbURpcmVjdG9yeShiYXNlUGF0aCk7XHJcblx0XHRcdGNvbnN0IGNvbXBhcmU6IHsgbmFtZTogc3RyaW5nOyBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50IHwgdW5kZWZpbmVkOyB9W10gPSBbXTtcclxuXHJcblx0XHRcdGZvciAoY29uc3Qgc2FtcGxlIG9mIGFici5zYW1wbGVzKSB7XHJcblx0XHRcdFx0Y29uc3QgY2FudmFzID0gYWxwaGFUb0NhbnZhcyhzYW1wbGUuYWxwaGEsIHNhbXBsZS5ib3VuZHMudywgc2FtcGxlLmJvdW5kcy5oKTtcclxuXHRcdFx0XHRkZWxldGUgKHNhbXBsZSBhcyBhbnkpLmFscGhhO1xyXG5cdFx0XHRcdGNvbnN0IG5hbWUgPSBgc2FtcGxlLSR7c2FtcGxlLmlkfS5wbmdgO1xyXG5cdFx0XHRcdGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKHJlc3VsdHNQYXRoLCBuYW1lKSwgY2FudmFzLnRvQnVmZmVyKCkpO1xyXG5cdFx0XHRcdGNvbXBhcmUucHVzaCh7IG5hbWUsIGNhbnZhcyB9KTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Zm9yIChjb25zdCBwYXR0ZXJuIG9mIGFici5wYXR0ZXJucykge1xyXG5cdFx0XHRcdGNvbnN0IGNhbnZhcyA9IHJnYlRvQ2FudmFzKHBhdHRlcm4uZGF0YSwgcGF0dGVybi5ib3VuZHMudywgcGF0dGVybi5ib3VuZHMuaCk7XHJcblx0XHRcdFx0ZGVsZXRlIChwYXR0ZXJuIGFzIGFueSkuZGF0YTtcclxuXHRcdFx0XHRjb25zdCBuYW1lID0gYHBhdHRlcm4tJHtwYXR0ZXJuLmlkfS5wbmdgO1xyXG5cdFx0XHRcdGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKHJlc3VsdHNQYXRoLCBuYW1lKSwgY2FudmFzLnRvQnVmZmVyKCkpO1xyXG5cdFx0XHRcdGNvbXBhcmUucHVzaCh7IG5hbWUsIGNhbnZhcyB9KTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gY29uc29sZS5sb2cocmVxdWlyZSgndXRpbCcpLmluc3BlY3QoYWJyLCBmYWxzZSwgOTksIHRydWUpKTtcclxuXHJcblx0XHRcdGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKHJlc3VsdHNQYXRoLCAnZGF0YS5qc29uJyksIEpTT04uc3RyaW5naWZ5KGFiciwgbnVsbCwgMiksICd1dGY4Jyk7XHJcblx0XHRcdGNvbnN0IGV4cGVjdGVkID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKGJhc2VQYXRoLCAnZGF0YS5qc29uJyksICd1dGY4JykpO1xyXG5cclxuXHRcdFx0ZXhwZWN0KGFicikuZXFsKGV4cGVjdGVkLCBmKTtcclxuXHRcdFx0Y29tcGFyZS5mb3JFYWNoKGkgPT4gY29tcGFyZUNhbnZhc2VzKGltYWdlc1tpLm5hbWVdLCBpLmNhbnZhcywgYCR7Zn0vJHtpLm5hbWV9YCkpO1xyXG5cdFx0fSk7XHJcblx0fSk7XHJcblxyXG5cdGl0LnNraXAoJ3Rlc3QnLCAoKSA9PiB7XHJcblx0XHRjb25zdCBmaWxlTmFtZSA9IGBFOlxcXFxEb3dubG9hZHNcXFxcRmlyZV9CcnVzaGVzXy1fUGl4aXZ1LmFicmA7XHJcblx0XHRjb25zdCBhYnIgPSByZWFkQWJyKGZzLnJlYWRGaWxlU3luYyhmaWxlTmFtZSksIHsgbG9nTWlzc2luZ0ZlYXR1cmVzOiB0cnVlIH0pO1xyXG5cdFx0Y29uc29sZS5sb2cocmVxdWlyZSgndXRpbCcpLmluc3BlY3QoYWJyLCBmYWxzZSwgOTksIHRydWUpKTtcclxuXHR9KTtcclxuXHJcblx0aXQuc2tpcCgndGVzdCcsIGZ1bmN0aW9uICgpIHtcclxuXHRcdHRoaXMudGltZW91dCg2MCAqIDEwMDApO1xyXG5cclxuXHRcdGNvbnN0IGJhc2VQYXRoID0gYEU6XFxcXERvd25sb2Fkc1xcXFxCcnVzaGVzLTIwMjExMjMxVDE1MTAyMVotMDAxXFxcXEJydXNoZXNgO1xyXG5cdFx0Y29uc3Qgb3V0cHV0UGF0aCA9IGBFOlxcXFxEb3dubG9hZHNcXFxcb3V0cHV0YDtcclxuXHJcblx0XHRmb3IgKGNvbnN0IGRpciBvZiBmcy5yZWFkZGlyU3luYyhiYXNlUGF0aCkpIHtcclxuXHRcdFx0Y29uc3QgZGlyUGF0aCA9IHBhdGguam9pbihiYXNlUGF0aCwgZGlyKTtcclxuXHJcblx0XHRcdGZvciAoY29uc3QgZmlsZSBvZiBmcy5yZWFkZGlyU3luYyhkaXJQYXRoKSkge1xyXG5cdFx0XHRcdGlmICghL1xcLmFiciQvLnRlc3QoZmlsZSkpIGNvbnRpbnVlO1xyXG5cclxuXHRcdFx0XHRjb25zdCBmaWxlUGF0aCA9IHBhdGguam9pbihiYXNlUGF0aCwgZGlyLCBmaWxlKTtcclxuXHJcblx0XHRcdFx0Y29uc29sZS5sb2coZmlsZVBhdGgpO1xyXG5cdFx0XHRcdGNvbnN0IGFiciA9IHJlYWRBYnIoZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoKSk7XHJcblx0XHRcdFx0Y29uc29sZS5sb2cocmVxdWlyZSgndXRpbCcpLmluc3BlY3QoYWJyLCBmYWxzZSwgOTksIHRydWUpKTtcclxuXHJcblx0XHRcdFx0aWYgKDApIHtcclxuXHRcdFx0XHRcdGZzLnJtU3luYyhwYXRoLmpvaW4ob3V0cHV0UGF0aCwgZmlsZSksIHsgcmVjdXJzaXZlOiB0cnVlLCBmb3JjZTogdHJ1ZSB9KTtcclxuXHRcdFx0XHRcdGZzLm1rZGlyU3luYyhwYXRoLmpvaW4ob3V0cHV0UGF0aCwgZmlsZSkpO1xyXG5cclxuXHRcdFx0XHRcdGZvciAoY29uc3Qgc2FtcGxlIG9mIGFici5zYW1wbGVzKSB7XHJcblx0XHRcdFx0XHRcdGNvbnN0IGNhbnZhcyA9IGFscGhhVG9DYW52YXMoc2FtcGxlLmFscGhhLCBzYW1wbGUuYm91bmRzLncsIHNhbXBsZS5ib3VuZHMuaCk7XHJcblx0XHRcdFx0XHRcdGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKG91dHB1dFBhdGgsIGZpbGUsICdzYW1wbGUtJyArIHNhbXBsZS5pZCArICcucG5nJyksIGNhbnZhcy50b0J1ZmZlcigpKTtcclxuXHRcdFx0XHRcdFx0ZGVsZXRlIChzYW1wbGUgYXMgYW55KS5hbHBoYTtcclxuXHRcdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0XHRmb3IgKGNvbnN0IHBhdHRlcm4gb2YgYWJyLnBhdHRlcm5zKSB7XHJcblx0XHRcdFx0XHRcdGNvbnN0IGNhbnZhcyA9IHJnYlRvQ2FudmFzKHBhdHRlcm4uZGF0YSwgcGF0dGVybi5ib3VuZHMudywgcGF0dGVybi5ib3VuZHMuaCk7XHJcblx0XHRcdFx0XHRcdGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKG91dHB1dFBhdGgsIGZpbGUsICdwYXR0ZXJuLScgKyBwYXR0ZXJuLmlkICsgJy5wbmcnKSwgY2FudmFzLnRvQnVmZmVyKCkpO1xyXG5cdFx0XHRcdFx0XHRkZWxldGUgKHBhdHRlcm4gYXMgYW55KS5kYXRhO1xyXG5cdFx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRcdGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKG91dHB1dFBhdGgsIGZpbGUsICdpbmZvLmpzb24nKSwgSlNPTi5zdHJpbmdpZnkoYWJyLCBudWxsLCAyKSwgJ3V0ZjgnKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHR9KVxyXG59KTtcclxuXHJcbmZ1bmN0aW9uIGFscGhhVG9DYW52YXMoYWxwaGE6IFVpbnQ4QXJyYXksIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XHJcblx0Y29uc3QgY2FudmFzID0gY3JlYXRlQ2FudmFzKHdpZHRoLCBoZWlnaHQpO1xyXG5cdGNvbnN0IGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKSE7XHJcblx0Y29uc3QgaW1hZ2VEYXRhID0gY29udGV4dC5nZXRJbWFnZURhdGEoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcclxuXHJcblx0Zm9yIChsZXQgc3JjID0gMCwgZHN0ID0gMDsgc3JjIDwgYWxwaGEubGVuZ3RoOyBzcmMrKywgZHN0ICs9IDQpIHtcclxuXHRcdGltYWdlRGF0YS5kYXRhW2RzdCArIDBdID0gMjU1O1xyXG5cdFx0aW1hZ2VEYXRhLmRhdGFbZHN0ICsgMV0gPSAyNTU7XHJcblx0XHRpbWFnZURhdGEuZGF0YVtkc3QgKyAyXSA9IDI1NTtcclxuXHRcdGltYWdlRGF0YS5kYXRhW2RzdCArIDNdID0gYWxwaGFbc3JjXTtcclxuXHR9XHJcblxyXG5cdGNvbnRleHQucHV0SW1hZ2VEYXRhKGltYWdlRGF0YSwgMCwgMCk7XHJcblx0cmV0dXJuIGNhbnZhcztcclxufVxyXG5cclxuZnVuY3Rpb24gcmdiVG9DYW52YXMocmdiOiBVaW50OEFycmF5LCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcikge1xyXG5cdGNvbnN0IGNhbnZhcyA9IGNyZWF0ZUNhbnZhcyh3aWR0aCwgaGVpZ2h0KTtcclxuXHRjb25zdCBjb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoJzJkJykhO1xyXG5cdGNvbnN0IGltYWdlRGF0YSA9IGNvbnRleHQuZ2V0SW1hZ2VEYXRhKDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XHJcblx0aW1hZ2VEYXRhLmRhdGEuc2V0KHJnYik7XHJcblx0Y29udGV4dC5wdXRJbWFnZURhdGEoaW1hZ2VEYXRhLCAwLCAwKTtcclxuXHRyZXR1cm4gY2FudmFzO1xyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiRjpcXHByb2plY3RzXFxhZy1wc2RcXHNyYyJ9
