"use strict";
/// <reference types="mocha" />
/// <reference path="../../typings/chai.d.ts" />
/// <reference path="../../typings/canvas.d.ts" />
Object.defineProperty(exports, "__esModule", { value: true });
exports.expectBuffersEqual = exports.compareBuffers = exports.compareCanvases = exports.compareTwoFiles = exports.loadCanvasFromFile = exports.saveCanvas = exports.extractPSD = exports.readPsdFromFile = exports.createReaderFromBuffer = exports.loadImagesFromDirectory = exports.importPSD = exports.range = exports.repeat = exports.toArrayBuffer = exports.createCanvas = void 0;
require('source-map-support').install();
var fs = require("fs");
var path = require("path");
var canvas_1 = require("canvas");
Object.defineProperty(exports, "createCanvas", { enumerable: true, get: function () { return canvas_1.createCanvas; } });
require("../initializeCanvas");
var psdReader_1 = require("../psdReader");
var descriptor_1 = require("../descriptor");
(0, descriptor_1.setLogErrors)(true);
var resultsPath = path.join(__dirname, '..', '..', 'results');
function toArrayBuffer(buffer) {
    var ab = new ArrayBuffer(buffer.length);
    var view = new Uint8Array(ab);
    for (var i = 0; i < buffer.length; ++i) {
        view[i] = buffer[i];
    }
    return ab;
}
exports.toArrayBuffer = toArrayBuffer;
function repeat(times) {
    var values = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        values[_i - 1] = arguments[_i];
    }
    if (!values.length) {
        throw new Error('missing values');
    }
    var array = [];
    for (var i = 0; i < times; i++) {
        array.push.apply(array, values);
    }
    return array;
}
exports.repeat = repeat;
function range(start, length) {
    var array = [];
    for (var i = 0; i < length; i++) {
        array.push(start + i);
    }
    return array;
}
exports.range = range;
function importPSD(dirName) {
    var dataPath = path.join(dirName, 'data.json');
    if (!fs.existsSync(dataPath))
        return undefined;
    return JSON.parse(fs.readFileSync(dataPath, 'utf8'));
}
exports.importPSD = importPSD;
function loadImagesFromDirectory(dirName) {
    var images = {};
    fs.readdirSync(dirName)
        .filter(function (f) { return /\.png$/.test(f); })
        .forEach(function (f) { return images[f] = loadCanvasFromFile(path.join(dirName, f)); });
    return images;
}
exports.loadImagesFromDirectory = loadImagesFromDirectory;
function createReaderFromBuffer(buffer) {
    var reader = (0, psdReader_1.createReader)(buffer.buffer, buffer.byteOffset, buffer.byteLength);
    reader.strict = true; // for testing
    return reader;
}
exports.createReaderFromBuffer = createReaderFromBuffer;
function readPsdFromFile(fileName, options) {
    var buffer = fs.readFileSync(fileName);
    var reader = createReaderFromBuffer(buffer);
    return (0, psdReader_1.readPsd)(reader, options);
}
exports.readPsdFromFile = readPsdFromFile;
function extractPSD(filePath, psd) {
    var basePath = path.join(resultsPath, filePath);
    if (!fs.existsSync(basePath))
        fs.mkdirSync(basePath);
    if (psd.canvas) {
        fs.writeFileSync(path.join(basePath, 'canvas.png'), psd.canvas.toBuffer());
        psd.canvas = undefined;
    }
    psd.children.forEach(function (l, i) {
        if (l.canvas) {
            fs.writeFileSync(path.join(basePath, "layer-".concat(i, ".png")), l.canvas.toBuffer());
            l.canvas = undefined;
        }
    });
    fs.writeFileSync(path.join(basePath, 'data.json'), JSON.stringify(psd, null, 2));
}
exports.extractPSD = extractPSD;
function saveCanvas(fileName, canvas) {
    if (canvas) {
        fs.writeFileSync(fileName, canvas.toBuffer());
    }
}
exports.saveCanvas = saveCanvas;
function loadCanvasFromFile(filePath) {
    var img = new canvas_1.Image();
    img.src = fs.readFileSync(filePath);
    var canvas = (0, canvas_1.createCanvas)(img.width, img.height);
    canvas.getContext('2d').drawImage(img, 0, 0);
    return canvas;
}
exports.loadCanvasFromFile = loadCanvasFromFile;
function compareTwoFiles(expectedPath, actual, name) {
    var expectedBuffer = fs.readFileSync(expectedPath);
    var expected = new Uint8Array(expectedBuffer.buffer, expectedBuffer.byteOffset, expectedBuffer.byteLength);
    if (expected.byteLength !== actual.byteLength) {
        throw new Error("File size is different than expected (".concat(name, ")"));
    }
    for (var i = 0; i < expected.byteLength; i++) {
        if (expected[i] !== actual[i]) {
            throw new Error("Actual file different than expected at index ".concat(i, ": actual ").concat(actual[i], ", expected ").concat(expected[i]));
        }
    }
}
exports.compareTwoFiles = compareTwoFiles;
function compareCanvases(expected, actual, name) {
    var saveFailure = function () {
        var failuresDir = path.join(resultsPath, 'failures');
        if (!fs.existsSync(failuresDir)) {
            fs.mkdirSync(failuresDir);
        }
        fs.writeFileSync(path.join(failuresDir, "".concat(name.replace(/[\\/]/, '-'))), actual.toBuffer());
    };
    if (expected === actual)
        return;
    if (!expected)
        throw new Error("Expected canvas is null (".concat(name, ")"));
    if (!actual)
        throw new Error("Actual canvas is null (".concat(name, ")"));
    if (expected.width !== actual.width || expected.height !== actual.height) {
        saveFailure();
        throw new Error("Canvas size is different than expected (".concat(name, ")"));
    }
    var expectedData = expected.getContext('2d').getImageData(0, 0, expected.width, expected.height);
    var actualData = actual.getContext('2d').getImageData(0, 0, actual.width, actual.height);
    var length = expectedData.width * expectedData.height * 4;
    for (var i = 0; i < length; i++) {
        if (expectedData.data[i] !== actualData.data[i]) {
            saveFailure();
            var expectedNumBytes = expectedData.data.length;
            var actualNumBytes = actualData.data.length;
            throw new Error("Actual canvas (".concat(actualNumBytes, " bytes) different ") +
                "than expected (".concat(name, ": ").concat(expectedNumBytes, " bytes) ") +
                "at index ".concat(i, ": actual ").concat(actualData.data[i], " vs. expected ").concat(expectedData.data[i]));
        }
    }
}
exports.compareCanvases = compareCanvases;
function compareBuffers(actual, expected, test, start, offset) {
    if (start === void 0) { start = 0; }
    if (offset === void 0) { offset = 0; }
    if (!actual)
        throw new Error("Actual buffer is null or undefined (".concat(test, ")"));
    if (!expected)
        throw new Error("Expected buffer is null or undefined (".concat(test, ")"));
    for (var i = start; i < expected.length; i++) {
        if (expected[i] !== actual[i + offset]) {
            throw new Error("Buffers differ " +
                "expected: 0x".concat(expected[i].toString(16), " at [0x").concat(i.toString(16), "] ") +
                "actual: 0x".concat(actual[i + offset].toString(16), " at [0x").concat((i + offset).toString(16), "] (").concat(test, ")"));
        }
    }
    if (actual.length !== expected.length)
        throw new Error("Buffers differ in size actual: ".concat(actual.length, " expected: ").concat(expected.length, " (").concat(test, ")"));
}
exports.compareBuffers = compareBuffers;
function expectBuffersEqual(actual, expected, name) {
    var length = Math.max(actual.length, expected.length);
    for (var i = 0; i < length; i++) {
        if (actual[i] !== expected[i]) {
            fs.writeFileSync(path.join(__dirname, '..', '..', 'results', name), Buffer.from(actual));
            throw new Error("Different byte at 0x".concat(i.toString(16), " in (").concat(name, ")"));
        }
    }
}
exports.expectBuffersEqual = expectBuffersEqual;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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IiwiZmlsZSI6InRlc3QvY29tbW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgdHlwZXM9XCJtb2NoYVwiIC8+XHJcbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi90eXBpbmdzL2NoYWkuZC50c1wiIC8+XHJcbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi90eXBpbmdzL2NhbnZhcy5kLnRzXCIgLz5cclxuXHJcbnJlcXVpcmUoJ3NvdXJjZS1tYXAtc3VwcG9ydCcpLmluc3RhbGwoKTtcclxuXHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0IHsgY3JlYXRlQ2FudmFzLCBJbWFnZSB9IGZyb20gJ2NhbnZhcyc7XHJcbmltcG9ydCAnLi4vaW5pdGlhbGl6ZUNhbnZhcyc7XHJcbmltcG9ydCB7IFBzZCwgUmVhZE9wdGlvbnMgfSBmcm9tICcuLi9pbmRleCc7XHJcbmltcG9ydCB7IHJlYWRQc2QsIGNyZWF0ZVJlYWRlciB9IGZyb20gJy4uL3BzZFJlYWRlcic7XHJcbmltcG9ydCB7IHNldExvZ0Vycm9ycyB9IGZyb20gJy4uL2Rlc2NyaXB0b3InO1xyXG5leHBvcnQgeyBjcmVhdGVDYW52YXMgfTtcclxuXHJcbnNldExvZ0Vycm9ycyh0cnVlKTtcclxuXHJcbmNvbnN0IHJlc3VsdHNQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3Jlc3VsdHMnKTtcclxuXHJcbmV4cG9ydCB0eXBlIEltYWdlTWFwID0geyBba2V5OiBzdHJpbmddOiBIVE1MQ2FudmFzRWxlbWVudCB9O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRvQXJyYXlCdWZmZXIoYnVmZmVyOiBCdWZmZXIpIHtcclxuXHRjb25zdCBhYiA9IG5ldyBBcnJheUJ1ZmZlcihidWZmZXIubGVuZ3RoKTtcclxuXHRjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYWIpO1xyXG5cclxuXHRmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlci5sZW5ndGg7ICsraSkge1xyXG5cdFx0dmlld1tpXSA9IGJ1ZmZlcltpXTtcclxuXHR9XHJcblxyXG5cdHJldHVybiBhYjtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJlcGVhdDxUPih0aW1lczogbnVtYmVyLCAuLi52YWx1ZXM6IFRbXSk6IFRbXSB7XHJcblx0aWYgKCF2YWx1ZXMubGVuZ3RoKSB7XHJcblx0XHR0aHJvdyBuZXcgRXJyb3IoJ21pc3NpbmcgdmFsdWVzJyk7XHJcblx0fVxyXG5cclxuXHRjb25zdCBhcnJheTogVFtdID0gW107XHJcblxyXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgdGltZXM7IGkrKykge1xyXG5cdFx0YXJyYXkucHVzaCguLi52YWx1ZXMpO1xyXG5cdH1cclxuXHJcblx0cmV0dXJuIGFycmF5O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmFuZ2Uoc3RhcnQ6IG51bWJlciwgbGVuZ3RoOiBudW1iZXIpOiBudW1iZXJbXSB7XHJcblx0Y29uc3QgYXJyYXk6IG51bWJlcltdID0gW107XHJcblxyXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuXHRcdGFycmF5LnB1c2goc3RhcnQgKyBpKTtcclxuXHR9XHJcblxyXG5cdHJldHVybiBhcnJheTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGltcG9ydFBTRChkaXJOYW1lOiBzdHJpbmcpOiBQc2QgfCB1bmRlZmluZWQge1xyXG5cdGNvbnN0IGRhdGFQYXRoID0gcGF0aC5qb2luKGRpck5hbWUsICdkYXRhLmpzb24nKTtcclxuXHJcblx0aWYgKCFmcy5leGlzdHNTeW5jKGRhdGFQYXRoKSlcclxuXHRcdHJldHVybiB1bmRlZmluZWQ7XHJcblxyXG5cdHJldHVybiBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhkYXRhUGF0aCwgJ3V0ZjgnKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2FkSW1hZ2VzRnJvbURpcmVjdG9yeShkaXJOYW1lOiBzdHJpbmcpIHtcclxuXHRjb25zdCBpbWFnZXM6IEltYWdlTWFwID0ge307XHJcblxyXG5cdGZzLnJlYWRkaXJTeW5jKGRpck5hbWUpXHJcblx0XHQuZmlsdGVyKGYgPT4gL1xcLnBuZyQvLnRlc3QoZikpXHJcblx0XHQuZm9yRWFjaChmID0+IGltYWdlc1tmXSA9IGxvYWRDYW52YXNGcm9tRmlsZShwYXRoLmpvaW4oZGlyTmFtZSwgZikpKTtcclxuXHJcblx0cmV0dXJuIGltYWdlcztcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJlYWRlckZyb21CdWZmZXIoYnVmZmVyOiBCdWZmZXIpIHtcclxuXHRjb25zdCByZWFkZXIgPSBjcmVhdGVSZWFkZXIoYnVmZmVyLmJ1ZmZlciwgYnVmZmVyLmJ5dGVPZmZzZXQsIGJ1ZmZlci5ieXRlTGVuZ3RoKTtcclxuXHRyZWFkZXIuc3RyaWN0ID0gdHJ1ZTsgLy8gZm9yIHRlc3RpbmdcclxuXHRyZXR1cm4gcmVhZGVyO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVhZFBzZEZyb21GaWxlKGZpbGVOYW1lOiBzdHJpbmcsIG9wdGlvbnM/OiBSZWFkT3B0aW9ucyk6IFBzZCB7XHJcblx0Y29uc3QgYnVmZmVyID0gZnMucmVhZEZpbGVTeW5jKGZpbGVOYW1lKTtcclxuXHRjb25zdCByZWFkZXIgPSBjcmVhdGVSZWFkZXJGcm9tQnVmZmVyKGJ1ZmZlcik7XHJcblx0cmV0dXJuIHJlYWRQc2QocmVhZGVyLCBvcHRpb25zKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGV4dHJhY3RQU0QoZmlsZVBhdGg6IHN0cmluZywgcHNkOiBQc2QpIHtcclxuXHRjb25zdCBiYXNlUGF0aCA9IHBhdGguam9pbihyZXN1bHRzUGF0aCwgZmlsZVBhdGgpO1xyXG5cclxuXHRpZiAoIWZzLmV4aXN0c1N5bmMoYmFzZVBhdGgpKVxyXG5cdFx0ZnMubWtkaXJTeW5jKGJhc2VQYXRoKTtcclxuXHJcblx0aWYgKHBzZC5jYW52YXMpIHtcclxuXHRcdGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKGJhc2VQYXRoLCAnY2FudmFzLnBuZycpLCBwc2QuY2FudmFzLnRvQnVmZmVyKCkpO1xyXG5cdFx0cHNkLmNhbnZhcyA9IHVuZGVmaW5lZDtcclxuXHR9XHJcblxyXG5cdHBzZC5jaGlsZHJlbiEuZm9yRWFjaCgobCwgaSkgPT4ge1xyXG5cdFx0aWYgKGwuY2FudmFzKSB7XHJcblx0XHRcdGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKGJhc2VQYXRoLCBgbGF5ZXItJHtpfS5wbmdgKSwgbC5jYW52YXMudG9CdWZmZXIoKSk7XHJcblx0XHRcdGwuY2FudmFzID0gdW5kZWZpbmVkO1xyXG5cdFx0fVxyXG5cdH0pO1xyXG5cclxuXHRmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihiYXNlUGF0aCwgJ2RhdGEuanNvbicpLCBKU09OLnN0cmluZ2lmeShwc2QsIG51bGwsIDIpKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNhdmVDYW52YXMoZmlsZU5hbWU6IHN0cmluZywgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCB8IHVuZGVmaW5lZCkge1xyXG5cdGlmIChjYW52YXMpIHtcclxuXHRcdGZzLndyaXRlRmlsZVN5bmMoZmlsZU5hbWUsIGNhbnZhcy50b0J1ZmZlcigpKTtcclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2FkQ2FudmFzRnJvbUZpbGUoZmlsZVBhdGg6IHN0cmluZykge1xyXG5cdGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xyXG5cdGltZy5zcmMgPSBmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgpO1xyXG5cdGNvbnN0IGNhbnZhcyA9IGNyZWF0ZUNhbnZhcyhpbWcud2lkdGgsIGltZy5oZWlnaHQpO1xyXG5cdGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpIS5kcmF3SW1hZ2UoaW1nLCAwLCAwKTtcclxuXHRyZXR1cm4gY2FudmFzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY29tcGFyZVR3b0ZpbGVzKGV4cGVjdGVkUGF0aDogc3RyaW5nLCBhY3R1YWw6IFVpbnQ4QXJyYXksIG5hbWU6IHN0cmluZykge1xyXG5cdGNvbnN0IGV4cGVjdGVkQnVmZmVyID0gZnMucmVhZEZpbGVTeW5jKGV4cGVjdGVkUGF0aCk7XHJcblx0Y29uc3QgZXhwZWN0ZWQgPSBuZXcgVWludDhBcnJheShleHBlY3RlZEJ1ZmZlci5idWZmZXIsIGV4cGVjdGVkQnVmZmVyLmJ5dGVPZmZzZXQsIGV4cGVjdGVkQnVmZmVyLmJ5dGVMZW5ndGgpO1xyXG5cclxuXHRpZiAoZXhwZWN0ZWQuYnl0ZUxlbmd0aCAhPT0gYWN0dWFsLmJ5dGVMZW5ndGgpIHtcclxuXHRcdHRocm93IG5ldyBFcnJvcihgRmlsZSBzaXplIGlzIGRpZmZlcmVudCB0aGFuIGV4cGVjdGVkICgke25hbWV9KWApO1xyXG5cdH1cclxuXHJcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBleHBlY3RlZC5ieXRlTGVuZ3RoOyBpKyspIHtcclxuXHRcdGlmIChleHBlY3RlZFtpXSAhPT0gYWN0dWFsW2ldKSB7XHJcblx0XHRcdHRocm93IG5ldyBFcnJvcihgQWN0dWFsIGZpbGUgZGlmZmVyZW50IHRoYW4gZXhwZWN0ZWQgYXQgaW5kZXggJHtpfTogYWN0dWFsICR7YWN0dWFsW2ldfSwgZXhwZWN0ZWQgJHtleHBlY3RlZFtpXX1gKTtcclxuXHRcdH1cclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wYXJlQ2FudmFzZXMoZXhwZWN0ZWQ6IEhUTUxDYW52YXNFbGVtZW50IHwgdW5kZWZpbmVkLCBhY3R1YWw6IEhUTUxDYW52YXNFbGVtZW50IHwgdW5kZWZpbmVkLCBuYW1lOiBzdHJpbmcpIHtcclxuXHRjb25zdCBzYXZlRmFpbHVyZSA9ICgpID0+IHtcclxuXHRcdGNvbnN0IGZhaWx1cmVzRGlyID0gcGF0aC5qb2luKHJlc3VsdHNQYXRoLCAnZmFpbHVyZXMnKTtcclxuXHRcdGlmICghZnMuZXhpc3RzU3luYyhmYWlsdXJlc0RpcikpIHtcclxuXHRcdFx0ZnMubWtkaXJTeW5jKGZhaWx1cmVzRGlyKTtcclxuXHRcdH1cclxuXHRcdGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKGZhaWx1cmVzRGlyLCBgJHtuYW1lLnJlcGxhY2UoL1tcXFxcL10vLCAnLScpfWApLCBhY3R1YWwhLnRvQnVmZmVyKCkpO1xyXG5cdH07XHJcblxyXG5cdGlmIChleHBlY3RlZCA9PT0gYWN0dWFsKVxyXG5cdFx0cmV0dXJuO1xyXG5cdGlmICghZXhwZWN0ZWQpXHJcblx0XHR0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIGNhbnZhcyBpcyBudWxsICgke25hbWV9KWApO1xyXG5cdGlmICghYWN0dWFsKVxyXG5cdFx0dGhyb3cgbmV3IEVycm9yKGBBY3R1YWwgY2FudmFzIGlzIG51bGwgKCR7bmFtZX0pYCk7XHJcblxyXG5cdGlmIChleHBlY3RlZC53aWR0aCAhPT0gYWN0dWFsLndpZHRoIHx8IGV4cGVjdGVkLmhlaWdodCAhPT0gYWN0dWFsLmhlaWdodCkge1xyXG5cdFx0c2F2ZUZhaWx1cmUoKTtcclxuXHRcdHRocm93IG5ldyBFcnJvcihgQ2FudmFzIHNpemUgaXMgZGlmZmVyZW50IHRoYW4gZXhwZWN0ZWQgKCR7bmFtZX0pYCk7XHJcblx0fVxyXG5cclxuXHRjb25zdCBleHBlY3RlZERhdGEgPSBleHBlY3RlZC5nZXRDb250ZXh0KCcyZCcpIS5nZXRJbWFnZURhdGEoMCwgMCwgZXhwZWN0ZWQud2lkdGgsIGV4cGVjdGVkLmhlaWdodCk7XHJcblx0Y29uc3QgYWN0dWFsRGF0YSA9IGFjdHVhbC5nZXRDb250ZXh0KCcyZCcpIS5nZXRJbWFnZURhdGEoMCwgMCwgYWN0dWFsLndpZHRoLCBhY3R1YWwuaGVpZ2h0KTtcclxuXHRjb25zdCBsZW5ndGggPSBleHBlY3RlZERhdGEud2lkdGggKiBleHBlY3RlZERhdGEuaGVpZ2h0ICogNDtcclxuXHJcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xyXG5cdFx0aWYgKGV4cGVjdGVkRGF0YS5kYXRhW2ldICE9PSBhY3R1YWxEYXRhLmRhdGFbaV0pIHtcclxuXHRcdFx0c2F2ZUZhaWx1cmUoKTtcclxuXHRcdFx0Y29uc3QgZXhwZWN0ZWROdW1CeXRlcyA9IGV4cGVjdGVkRGF0YS5kYXRhLmxlbmd0aDtcclxuXHRcdFx0Y29uc3QgYWN0dWFsTnVtQnl0ZXMgPSBhY3R1YWxEYXRhLmRhdGEubGVuZ3RoO1xyXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXHJcblx0XHRcdFx0YEFjdHVhbCBjYW52YXMgKCR7YWN0dWFsTnVtQnl0ZXN9IGJ5dGVzKSBkaWZmZXJlbnQgYCArXHJcblx0XHRcdFx0YHRoYW4gZXhwZWN0ZWQgKCR7bmFtZX06ICR7ZXhwZWN0ZWROdW1CeXRlc30gYnl0ZXMpIGAgK1xyXG5cdFx0XHRcdGBhdCBpbmRleCAke2l9OiBhY3R1YWwgJHthY3R1YWxEYXRhLmRhdGFbaV19IHZzLiBleHBlY3RlZCAke2V4cGVjdGVkRGF0YS5kYXRhW2ldfWBcclxuXHRcdFx0KTtcclxuXHRcdH1cclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wYXJlQnVmZmVycyhhY3R1YWw6IEJ1ZmZlciwgZXhwZWN0ZWQ6IEJ1ZmZlciwgdGVzdDogc3RyaW5nLCBzdGFydCA9IDAsIG9mZnNldCA9IDApIHtcclxuXHRpZiAoIWFjdHVhbClcclxuXHRcdHRocm93IG5ldyBFcnJvcihgQWN0dWFsIGJ1ZmZlciBpcyBudWxsIG9yIHVuZGVmaW5lZCAoJHt0ZXN0fSlgKTtcclxuXHRpZiAoIWV4cGVjdGVkKVxyXG5cdFx0dGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBidWZmZXIgaXMgbnVsbCBvciB1bmRlZmluZWQgKCR7dGVzdH0pYCk7XHJcblxyXG5cdGZvciAobGV0IGkgPSBzdGFydDsgaSA8IGV4cGVjdGVkLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRpZiAoZXhwZWN0ZWRbaV0gIT09IGFjdHVhbFtpICsgb2Zmc2V0XSkge1xyXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYEJ1ZmZlcnMgZGlmZmVyIGAgK1xyXG5cdFx0XHRcdGBleHBlY3RlZDogMHgke2V4cGVjdGVkW2ldLnRvU3RyaW5nKDE2KX0gYXQgWzB4JHtpLnRvU3RyaW5nKDE2KX1dIGAgK1xyXG5cdFx0XHRcdGBhY3R1YWw6IDB4JHthY3R1YWxbaSArIG9mZnNldF0udG9TdHJpbmcoMTYpfSBhdCBbMHgkeyhpICsgb2Zmc2V0KS50b1N0cmluZygxNil9XSAoJHt0ZXN0fSlgKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGlmIChhY3R1YWwubGVuZ3RoICE9PSBleHBlY3RlZC5sZW5ndGgpXHJcblx0XHR0aHJvdyBuZXcgRXJyb3IoYEJ1ZmZlcnMgZGlmZmVyIGluIHNpemUgYWN0dWFsOiAke2FjdHVhbC5sZW5ndGh9IGV4cGVjdGVkOiAke2V4cGVjdGVkLmxlbmd0aH0gKCR7dGVzdH0pYCk7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXhwZWN0QnVmZmVyc0VxdWFsKGFjdHVhbDogVWludDhBcnJheSwgZXhwZWN0ZWQ6IFVpbnQ4QXJyYXksIG5hbWU6IHN0cmluZykge1xyXG5cdGNvbnN0IGxlbmd0aCA9IE1hdGgubWF4KGFjdHVhbC5sZW5ndGgsIGV4cGVjdGVkLmxlbmd0aCk7XHJcblxyXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuXHRcdGlmIChhY3R1YWxbaV0gIT09IGV4cGVjdGVkW2ldKSB7XHJcblx0XHRcdGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3Jlc3VsdHMnLCBuYW1lKSwgQnVmZmVyLmZyb20oYWN0dWFsKSk7XHJcblx0XHRcdHRocm93IG5ldyBFcnJvcihgRGlmZmVyZW50IGJ5dGUgYXQgMHgke2kudG9TdHJpbmcoMTYpfSBpbiAoJHtuYW1lfSlgKTtcclxuXHRcdH1cclxuXHR9XHJcbn1cclxuIl0sInNvdXJjZVJvb3QiOiJGOlxccHJvamVjdHNcXGFnLXBzZFxcc3JjIn0=
